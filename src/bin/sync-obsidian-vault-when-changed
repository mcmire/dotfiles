#!/usr/bin/env zsh

# This script is designed to be run within a launch agent or init script and
# therefore executables may not be on the PATH.
#
# On macOS, you can get this by running: `brew install watchexec`
# On Termux, you can get this by running: `pkg install watchexec`
path_to_watchexec=
if [[ -e /data/data/com.termux/files/usr/bin/watchexec ]]; then
  path_to_watchexec=/data/data/com.termux/files/usr/bin/watchexec
elif [[ -e /opt/homebrew/bin/watchexec ]]; then
  path_to_watchexec=/opt/homebrew/bin/watchexec
else
  echo "ERROR: Could not find watchexec"
  exit 1
fi

saw_vault_directory_option=0
vault_directory="$1"

for arg in "$@"; do
  if [[ $saw_vault_directory_option -eq 1 ]]; then
    vault_directory="$arg"
    break
  fi

  if [[ $arg == "--vault-directory" || $arg == "-d" ]]; then
    saw_vault_directory_option=1
  fi
done

if [[ -z $vault_directory ]]; then
  echo "USAGE: $0 VAULT_DIRECTORY"
  exit 1
fi

if ! [[ -d $vault_directory ]]; then
  echo "ERROR: Could not find vault directory: $vault_directory"
  exit 1
fi

exec $path_to_watchexec \
  --watch "$vault_directory" \
  --on-busy-update=signal \
  --signal USR1 \
  --debounce 1s \
  $HOME/.bin/debounce \
  --duration 240 \
  -- \
  $HOME/.bin/sync-obsidian-vault-with-logging "$@"
