#!/usr/bin/env bash

# Inspired by: <https://github.com/caarlos0/dotfiles.fish/blob/d0ee6e9fc5991c80b412a313e913b83c3289d257/bin/tmux-sessionizer>
# Also see: <https://carlosbecker.com/posts/tmux-sessionizer/>

print-with-color() {
  echo -ne "\033[${1}m"
  echo -n "${@:2}"
  echo -ne "\033[0m"
}

info() {
  print-with-color 34 "$@" $'\n'
}

error() {
  print-with-color 31 "ERROR:" "$@" $'\n'
}

get-all-projects() {
  find ~/code -mindepth 2 -maxdepth 2 -type d
}

get-project-candidates-with-scores() {
  local query="$1"
  local score
  local path

  if [[ -n "$query" ]]; then
    zoxide query --list --score "$query"
    return
  fi

  # Load the entire zoxide db into an associative array once
  declare -A scores
  while read -r score path; do
    scores[$path]="$score"
  done < <(zoxide query --list --score)

  while read -r project; do
    if [[ -v scores[$project] ]]; then
      echo "${scores[$project]} $project"
    else
      echo "-1.0 $project"
    fi
  done < <(get-all-projects)
}

get-open-session-paths() {
  tmux list-sessions -F '#{session_path}' 2>/dev/null
}

format-for-display() {
  declare -A open
  local _
  local path
  local simplified_path
  local path_with_open_indicator

  while read -r session_path; do
    open[$session_path]=1
  done < <(get-open-session-paths)

  local cyan=$'\033[36m'
  local reset=$'\033[0m'

  while read -r _ path; do
    simplified_path="${path/#$HOME/\~}"
    if [[ -v open[$path] ]]; then
      path_with_open_indicator="${cyan}${simplified_path}  (open)${reset}"
    else
      path_with_open_indicator="${simplified_path}"
    fi
    echo "${path}"$'\t'"${path_with_open_indicator}"
  done < <(sort --key 1 --numeric-sort --reverse)
}

select-project() {
  local query="$1"

  if [[ -d "$query" ]]; then
    echo "$query"
  else
    get-project-candidates-with-scores "$query" | \
      format-for-display | \
      # For each line, show the second column, but choose the first
      fzf --query "$query" --no-sort --select-1 --exit-0 \
          --with-nth=2 --delimiter='\t' --ansi | \
      cut -f1
  fi
}

switch-to-guaranteed-tmux-session() {
  local tmux_session_name="$1"
  local project_directory="$2"

  if ! tmux has-session -t "=$tmux_session_name" &>/dev/null; then
    # -d prevents attaching to the current terminal (we will do that next)
    tmux new-session -d -s "$tmux_session_name" -c "$project_directory"
  fi
  tmux switch-client -t "=$tmux_session_name"
}

main() {
  local query="$1"

  if [[ -z "$TMUX" ]]; then
    error "It appears you are not in an active tmux session."
    error "Please start 'tmux' now, and then re-run this script."
    exit 1
  fi

  local resolved_project_directory
  resolved_project_directory="$(select-project "$query")"

  if [[ -z "$resolved_project_directory" && -n "$query" ]]; then
    error "Could not find a project matching '$query'."
    exit 1
  elif [[ -z "$resolved_project_directory" ]]; then
    exit 0
  fi

  # "Adding" is a misnomer here; we're just bumping the rank so the next time we
  # switch, this directory will be at the bottom of the fzf list (and will thus
  # be the one selected)
  zoxide add "$resolved_project_directory"

  local tmux_session_name
  tmux_session_name="$(basename "$resolved_project_directory" | tr . _)"
  switch-to-guaranteed-tmux-session "$tmux_session_name" "$resolved_project_directory"
}

main "$@"
